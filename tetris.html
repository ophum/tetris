<html>
<head>

</head>
<style>

*{
  padding: 0;
  margin: 0;
}

/* „Ç≤„Éº„É†ÁîªÈù¢Ë°®Á§∫Â†¥ÊâÄ„ÅÆÂ§ß„Åç„Åï„Å®„Åã */
#display {
  width: calc(24px * 12);
  height: calc(24px * 22);
}

/* 1„Éû„Çπ„ÅÆÂ§ß„Åç„Åï„Å®„ÅãËâ≤(„Éá„Éï„Ç©„É´„Éà Èªí) */
.cell {
  width: 22px;
  height: 22px;
  display:block;
  float: left;
  background-color: rgb(32, 32, 32);
  border-left: 1px solid rgb(64, 64, 64);
  border-top: 1px solid rgb(64, 64, 64);
  border-right: 1px solid rgb(16, 16, 16);
  border-bottom: 1px solid rgb(16, 16, 16);
}

/* Â§ñÂÅ¥„ÅÆÂ£ÅÁî®„ÅÆ„Éû„Çπ„ÅÆËâ≤(ÁÅ∞Ëâ≤) */
.wall {
  background-color: rgb(128, 128, 128);
  border-left: 1px solid rgb(192, 192, 192);
  border-top: 1px solid rgb(192, 192, 192);
  border-right: 1px solid rgb(64, 64, 64);
  border-bottom: 1px solid rgb(64, 64, 64);
}

.I {
  background-color: #3399ff;
  border-left: 1px solid #99ccff;
  border-top: 1px solid #99ccff;
  border-right: 1px solid #0066ff;
  border-bottom: 1px solid #0066ff;
}

.T {
  background-color: #cc33cc;
  border-left: 1px solid #cc66cc;
  border-top: 1px solid #cc66cc;
  border-right: 1px solid #cc00cc;
  border-bottom: 1px solid #cc00cc;
}

.O {
  background-color: #ccff00;
  border-left: 1px solid #ffff00;
  border-top: 1px solid #ffff00;
  border-right: 1px solid #99cc00;
  border-bottom: 1px solid #99cc00;
}

.Z {
  background-color: #ff0033;
  border-left: 1px solid #cc3366;
  border-top: 1px solid #cc3366;
  border-right: 1px solid #cc0033;
  border-bottom: 1px solid #cc0033;
}

.S {
  background-color: #66cc33;
  border-left: 1px solid #99ff66;
  border-top: 1px solid #99ff66;
  border-right: 1px solid #339900;
  border-bottom: 1px solid #339900;
}

.L {
  background-color: #ff6600;
  border-left: 1px solid #ff9966;
  border-top: 1px solid #ff9966;
  border-right: 1px solid #cc6633;
  border-bottom: 1px solid #cc6633;
}

.J {
  background-color: #0033cc;
  border-left: 1px solid #0066ff;
  border-top: 1px solid #0066ff;
  border-right: 1px solid #000099;
  border-bottom: 1px solid #000099;
}

#rotate, #left, #up, #right, #down {
  width: 48px;
  height: 48px;
  font-size: 32px;
}
</style>
<body> 

  <!-- Ë°®Á§∫Â†¥ÊâÄ -->
  <div id="display"></div>
  <div id="buttons">
    <input type="button" id="rotate" value="üîÅ">
    <input type="button" id="left" value="‚Üê">
    <input type="button" id="up" value="‚Üë">
    <input type="button" id="right" value="‚Üí">
    <input type="button" id="down" value="‚Üì">
  </div>

<script>


// „Éñ„É≠„ÉÉ„ÇØ„ÅÆ„Åß„Éº„Åü 
function Block(x, y, type) {
  this.x = x;
  this.y = y;
  this.type = type;
  this.status = 0;
}
var block = new Block(4, 0, Math.floor(Math.random() * (7)));

let field_width = 12;
let field_height = 22;
let Cell = {
  None : 0,
  Wall : 1,
  I : 2,
  O : 3,
  S : 4,
  Z : 5,
  J : 6,
  L : 7,
  T : 8,
};
// „Ç´„Ç¶„É≥„Çø
var cnt = 0;

// Âá∫ÂäõÁî®„É°„É¢„É™
var vram = [
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1],
  ];

// „Ç≤„Éº„É†„ÇíÁÆ°ÁêÜ„Åô„Çã„Åü„ÇÅ„ÅÆ„Éï„Ç£„Éº„É´„Éâ
var field = [
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1],
  ];

// ÂêÑ„Éñ„É≠„ÉÉ„ÇØ„ÇíÊ†ºÁ¥ç„Åô„Çã
let block_status = [1, 0, 1, 1, 3, 3, 3]
let blocks = [
  [ // I
    [
      [Cell.I,Cell.I,Cell.I,Cell.I]
    ],
    [
      [Cell.I],
      [Cell.I],
      [Cell.I],
      [Cell.I]
    ]
  ],
  [ // O
    [
      [Cell.O,Cell.O],
      [Cell.O,Cell.O]
    ]
  ],
  [ // S
    [
      [Cell.S,Cell.None],
      [Cell.S,Cell.S],
      [Cell.None,Cell.S]
    ],
    [
      [Cell.None,Cell.S,Cell.S],
      [Cell.S,Cell.S,Cell.None]
    ]
  ],
  [ // Z
    [
      [Cell.None,Cell.Z],
      [Cell.Z,Cell.Z],
      [Cell.Z,Cell.None]
    ],
    [
      [Cell.Z,Cell.Z,Cell.None],
      [Cell.None,Cell.Z,Cell.Z]
    ]
  ],
  [ // J
    [
      [Cell.None,Cell.J],
      [Cell.None,Cell.J],
      [Cell.J,Cell.J]
    ],
    [
      [Cell.J,Cell.None,Cell.None],
      [Cell.J,Cell.J,Cell.J]
    ],
    [
      [Cell.J,Cell.J],
      [Cell.J,Cell.None],
      [Cell.J,Cell.None]
    ],
    [
      [Cell.J,Cell.J,Cell.J],
      [Cell.None,Cell.None,Cell.J]
    ]
  ],
  [ // L
    [
      [Cell.L,Cell.None],
      [Cell.L,Cell.None],
      [Cell.L,Cell.L]
    ],
    [
      [Cell.L,Cell.L,Cell.L],
      [Cell.L,Cell.None,Cell.None]
    ],
    [
      [Cell.L,Cell.L],
      [Cell.None,Cell.L],
      [Cell.None,Cell.L]
    ],
    [
      [Cell.None,Cell.None,Cell.L],
      [Cell.L,Cell.L,Cell.L]
    ]
  ],
  [ // T
    [
      [Cell.T,Cell.None],
      [Cell.T,Cell.T],
      [Cell.T,Cell.None]
    ],
    [
      [Cell.T,Cell.T,Cell.T],
      [Cell.None,Cell.T,Cell.None]
    ],
    [
      [Cell.None,Cell.T],
      [Cell.T,Cell.T],
      [Cell.None,Cell.T]
    ],
    [
      [Cell.None,Cell.T,Cell.None],
      [Cell.T,Cell.T,Cell.T]
    ]
  ]
];

// ÈÖçÂàó„Ç≥„Éî„Éº
// sa : „Ç≥„Éî„ÉºÂÖÉÈÖçÂàó
// da : „Ç≥„Éî„ÉºÂÖàÈÖçÂàó
// sx : „Ç≥„Éî„ÉºÂÖÉ„ÅÆxÂ∫ßÊ®ô
// sy : „Ç≥„Éî„ÉºÂÖÉ„ÅÆyÂ∫ßÊ®ô
// dx : „Ç≥„Éî„ÉºÂÖà„ÅÆxÂ∫ßÊ®ô
// dy : „Ç≥„Éî„ÉºÂÖà„ÅÆyÂ∫ßÊ®ô
// width : „Ç≥„Éî„Éº„Åô„ÇãÂπÖ
// height : „Ç≥„Éî„Éº„Åô„ÇãÈ´ò„Åï
// ignore : „Ç≥„Éî„Éº„Åó„Å™„ÅÑÂÄ§
let copy = function(sa, da, sx, sy, dx, dy, ignore) {
  let width = sa[0].length;
  let height = sa.length;
  for(var i = 0; i < height; i++) {
    for(var j = 0; j < width; j++) {
      if(sa[sy + i][sx + j] == ignore) continue;
      da[dy + i][dx + j] = sa[sy + i][sx + j];
    }
  }
};

// btype„Å™„Éñ„É≠„ÉÉ„ÇØ„Åå(x, y)„Å™Â∫ßÊ®ô„Å´Ë®≠ÁΩÆ„Åß„Åç„Çã„Åã
let checkOkeru = function(btype, status, x, y) {
  console.log("status => " + status);
  var b = blocks[btype][status];
  let w = b[0].length;
  let h = b.length;
  for(var i = y; i < y + h; i++) {
    for(var j = x; j < x + w; j++) {
      if(b[i-y][j-x] == Cell.None) continue;
      if(field[i][j] != Cell.None) return false;
    }
  }
  return true;
};

// vram„Çídisplay„Å∏Âá∫Âäõ(vram to html)
let disp = function() {
  let d = document.getElementById("display"); // Âá∫ÂäõÂ†¥ÊâÄ„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó

  var s = ""; // display„Å∏Êõ∏„ÅçËæº„ÇÄhtml„ÇíÊ†ºÁ¥ç„Åô„ÇãÂ§âÊï∞

  for(var i = 0; i < 22; i++) {
    for(var j = 0; j < 12; j++) {
      s += "<div class='cell ";
      switch(vram[i][j]) {
      case Cell.Wall: s += "wall"; break;
      case Cell.I: s += "I"; break;
      case Cell.O: s += "O"; break;
      case Cell.S: s += "S"; break;
      case Cell.Z: s += "Z"; break;
      case Cell.J: s += "J"; break;
      case Cell.L: s += "L"; break;
      case Cell.T: s += "T"; break;
      case Cell.None: break;
      }
      s += "'></div>";
    }
  }

  d.innerHTML = s; // Ë¶ÅÁ¥†„Å´Êõ∏„ÅçËæº„Åø
}; 

// ÊèèÁîªÈñ¢‰øÇ
let graph = function() {
  copy(field, vram, 0, 0, 0, 0, -1, 0);
  copy(blocks[block.type][block.status], vram, 0, 0, block.x, block.y, 0);
  disp();
};

let process = function() {
  if(checkOkeru(block.type, block.status, block.x, block.y + 1)) block.y++;
  else next();
};

let delline = function(y) {
  for(var i = y; i > 0; i--) {
    for(var j = 1; j < field_width - 1; j++) {
      field[i][j] = field[i-1][j];
    }
  }
};

let next = function() {  
  // field„Å´Âõ∫ÂÆö
  copy(blocks[block.type][block.status], field, 0, 0, block.x, block.y, 0);
  graph();
  
  for(var i = 0; i < field_height - 1; i++){
    var cnt = 0;
    for(var j = 0; j < field_width; j++){
      cnt++;
      if(field[i][j] == Cell.None) break;
    }
    if(cnt == field_width) delline(i);
  }
  // Ê¨°„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÁôªÈå≤
  block.type = Math.floor(Math.random() * (7));
  block.x = 4;
  block.y = 0;
  block.status = 0;
};

// main loop
let loop = function() {
  console.log(cnt++);
  graph();
  process();
  setTimeout(loop, 1000);
};

document.getElementById("left").addEventListener("click", function() {
  if(checkOkeru(block.type, block.status, block.x - 1, block.y)) block.x--;
});

document.getElementById("up").addEventListener("click", function() {
  while(checkOkeru(block.type, block.status, block.x, block.y + 1)){
    block.y++;
  }
  next();
});

document.getElementById("down").addEventListener("click", function() {
  process();
});

document.getElementById("right").addEventListener("click", function() {
  if(checkOkeru(block.type, block.status, block.x + 1, block.y)) block.x++;
});

document.getElementById("rotate").addEventListener("click", function() {block.status++;
  if(block.status > block_status[block.type]) block.status = 0;
  if(!checkOkeru(block.type, block.status, block.x, block.y)){
    block.status--;
    if(block.status < 0) block.status = block_status[block.type];
  }
});
// „Ç≠„Éº„Ç§„Éô„É≥„Éà
document.addEventListener("keydown", function(e) {
  console.log("keycode = " + e.keyCode);
  switch(e.keyCode) {
  case 37: // ‚Üê
    if(checkOkeru(block.type, block.status, block.x - 1, block.y)) block.x--;
    break;
  case 38:
    while(checkOkeru(block.type, block.status, block.x, block.y + 1)){
      block.y++;
    }
    next();
    break;
  case 39: // ‚Üí
    if(checkOkeru(block.type, block.status, block.x + 1, block.y)) block.x++;
    break;
  case 40: // ‚Üì
    process();
    break;
  case 65: // 'a'
    block.status--;
    if(block.status < 0) block.status = block_status[block.type];
    if(!checkOkeru(block.type, block.status, block.x, block.y)) {
      block.status++;
      if(block.status > block_status[block.type]) block.status = 0;
    }
    break;
  case 83: // 's'
    block.status++;
    if(block.status > block_status[block.type]) block.status = 0;
    if(!checkOkeru(block.type, block.status, block.x, block.y)){
      block.status--;
      if(block.status < 0) block.status = block_status[block.type];
    }
    break;
  }
  console.log("block_status => " + block.status);
  graph();
});
loop();
</script>
</body>
</html>
